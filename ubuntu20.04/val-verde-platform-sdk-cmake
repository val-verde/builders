#!/bin/bash

set -e

BINDIR=${BINDIR:-${PACKAGE_ROOT}/bin}
BINTOOLS_PREFIX=${BINTOOLS_PREFIX:-llvm-}
BINTOOLS_PATH_PREFIX=${BINDIR}/${BINTOOLS_PREFIX}
BUILD_TYPE=${BUILD_TYPE:-MinSizeRel}
LINKER_OPTIMIZATION_LEVEL=${LINKER_OPTIMIZATION_LEVEL:-2}
OPTIMIZATION_LEVEL=${OPTIMIZATION_LEVEL:-z}
SYSROOT=${SYSROOT:-${PACKAGE_ROOT}/${PACKAGE_BASE_NAME}-platform-sdk-${HOST_OS}${HOST_OS_API_LEVEL}-${HOST_PROCESSOR}/sysroot}
SYSTEM_NAME=${SYSTEM_NAME:-Linux}

LDFLAGS="${ARCH_FLAGS} ${LDFLAGS} -O${LINKER_OPTIMIZATION_LEVEL}"

if [ -z "${DISABLE_STRIP}" ]; then
    LDFLAGS="${LDFLAGS} -s"
fi

if [ -n "${ENABLE_FLTO}" ]; then
    FLTO_OPTION=`echo ${ENABLE_FLTO} | tr '[:upper:]' '[:lower:]'`
    FLTO_CFLAG="-flto=${FLTO_OPTION}"
fi

if [ "${BUILD_TRIPLE}" != "${HOST_TRIPLE}" ]; then
    CROSSCOMPILING_CMD="-DCMAKE_CROSSCOMPILING=TRUE"
    SYSTEM_NAME_CMD="-DCMAKE_SYSTEM_NAME=${SYSTEM_NAME}"
fi

AR=${AR:-${BINTOOLS_PATH_PREFIX}ar}
CC=${CC:-${BINDIR}/clang}
CPP=${CPP:-"${CC} -E"}
CXX=${CXX:-${BINDIR}/clang++}
DLLTOOL=${DLLTOOL:-${BINTOOLS_PATH_PREFIX}dlltool}
LD=${LD:-${BINDIR}/ld.lld}
NM=${NM:-${BINTOOLS_PATH_PREFIX}nm}
OBJCOPY=${OBJCOPY:-${BINTOOLS_PATH_PREFIX}objcopy}
OBJDUMP=${OBJDUMP:-${BINTOOLS_PATH_PREFIX}objdump}
RANLIB=${RANLIB:-${BINTOOLS_PATH_PREFIX}ranlib}
RC=${RC:-${BINTOOLS_PATH_PREFIX}rc}
READELF=${READELF:-${BINTOOLS_PATH_PREFIX}readelf}
SIZE=${SIZE:-${BINTOOLS_PATH_PREFIX}size}
STRINGS=${STRINGS:-${BINTOOLS_PATH_PREFIX}strings}
STRIP=${STRIP:-${BINTOOLS_PATH_PREFIX}strip}

cmake \
    -G Ninja \
    -DCMAKE_AR=${AR} \
    -DCMAKE_ASM_COMPILER=${CC} \
    -DCMAKE_ASM_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_ASM_COMPILER_ID=Clang \
    -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
    -DCMAKE_C_COMPILER=${CC} \
    -DCMAKE_C_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_C_FLAGS="${ARCH_FLAGS} -O${OPTIMIZATION_LEVEL} ${CFLAGS}" \
    -DCMAKE_C_FLAGS_MINSIZEREL="${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL}" \
    -DCMAKE_CXX_COMPILER=${CXX} \
    -DCMAKE_CXX_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_CXX_FLAGS="${ARCH_FLAGS} -O${OPTIMIZATION_LEVEL} ${CXXFLAGS}" \
    -DCMAKE_CXX_FLAGS_MINSIZEREL="${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL}" \
    -DCMAKE_EXE_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_LINKER=${LD} \
    -DCMAKE_MODULE_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_NM=${NM} \
    -DCMAKE_OBJCOPY=${OBJCOPY} \
    -DCMAKE_OBJDUMP=${OBJDUMP} \
    -DCMAKE_PREFIX_PATH=${SYSROOT}/usr/lib/pkgconfig \
    -DCMAKE_RANLIB=${RANLIB} \
    -DCMAKE_RC_COMPILER=${RC} \
    -DCMAKE_READELF=${READELF} \
    -DCMAKE_STRINGS=${STRINGS} \
    -DCMAKE_STRIP=${STRIP} \
    -DCMAKE_SHARED_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_SYSROOT=${SYSROOT} \
    -DCMAKE_SYSTEM_PROCESSOR=${HOST_PROCESSOR} \
    "${CROSSCOMPILING_CMD}" \
    "${SYSTEM_NAME_CMD}" \
    "$@"
