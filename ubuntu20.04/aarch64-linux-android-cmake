#!/bin/bash

ANDROID_NDK_HOME=${PACKAGE_ROOT}/android-ndk-r21d
PACKAGE_BINROOT=${PACKAGE_ROOT}/bin
CLANG_COMMON_ARGS=-Oz
LLD_COMMON_ARGS="-s -O2"

cmake \
    -G Ninja \
    -DANDROID_NDK=${ANDROID_NDK_HOME} \
    -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
    -DCMAKE_ANDROID_STL_TYPE=c++_shared \
    -DCMAKE_AR=${PACKAGE_BINROOT}/llvm-ar \
    -DCMAKE_AS=${PACKAGE_BINROOT}/llvm-as \
    -DCMAKE_BUILD_TYPE=MinSizeRel \
    -DCMAKE_C_FLAGS_MINSIZEREL="${CLANG_COMMON_ARGS}" \
    -DCMAKE_CXX_FLAGS_MINSIZEREL="${CLANG_COMMON_ARGS}" \
    -DCMAKE_EXE_LINKER_FLAGS="${LLD_COMMON_ARGS}" \
    -DCMAKE_LINKER=${PACKAGE_BINROOT}/ld.lld \
    -DCMAKE_MODULE_LINKER_FLAGS="${LLD_COMMON_ARGS}" \
    -DCMAKE_NM=${PACKAGE_BINROOT}/llvm-nm \
    -DCMAKE_OBJCOPY=${PACKAGE_BINROOT}/llvm-objcopy \
    -DCMAKE_OBJDUMP=${PACKAGE_BINROOT}/llvm-objdump \
    -DCMAKE_PREFIX_PATH=${PACKAGE_PREFIX}/lib/pkgconfig \
    -DCMAKE_RANLIB=${PACKAGE_BINROOT}/llvm-ranlib \
    -DCMAKE_READELF=${PACKAGE_BINROOT}/llvm-readelf \
    -DCMAKE_STRINGS=${PACKAGE_BINROOT}/llvm-strings \
    -DCMAKE_STRIP=${PACKAGE_BINROOT}/llvm-strip \
    -DCMAKE_SHARED_LINKER_FLAGS="${LLD_COMMON_ARGS}" \
    -DCMAKE_SYSTEM_NAME=Android \
    -DCMAKE_SYSTEM_VERSION=${HOST_OS_API_LEVEL} \
    "$@"