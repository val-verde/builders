#!/bin/bash

set -e

if [ "${ENABLE_FLTO}" = "Full" ]; then
    FLTO_CFLAG=-flto
    FLTO_LDFLAG="-O2"
fi

BINDIR=${PACKAGE_ROOT}/bin
BUILD_TYPE=${BUILD_TYPE:-MinSizeRel}
FLTO_LDFLAG="${FLTO_LDFLAG} -s"
OPTIMIZATION_LEVEL=${OPTIMIZATION_LEVEL:-z}

AR=${AR:-${BINDIR}/llvm-ar}
CC=${CC:-${BINDIR}/clang}
CPP=${CPP:-"${CC} -E"}
CXX=${CXX:-${BINDIR}/clang++}
DLLTOOL=${DLLTOOL:-${BINDIR}/llvm-dlltool}
LD=${LD:-${BINDIR}/ld.lld}
NM=${NM:-${BINDIR}/llvm-nm}
OBJCOPY=${OBJCOPY:-${BINDIR}/llvm-objcopy}
OBJDUMP=${OBJDUMP:-${BINDIR}/llvm-objdump}
RANLIB=${RANLIB:-${BINDIR}/llvm-ranlib}
RC=${RC:-${BINDIR}/llvm-rc}
READELF=${READELF:-${BINDIR}/llvm-readelf}
SIZE=${SIZE:-${BINDIR}/llvm-size}
STRINGS=${STRINGS:-${BINDIR}/llvm-strings}
STRIP=${STRIP:-${BINDIR}/llvm-strip}

cmake \
    -G Ninja \
    -DCMAKE_AR=${AR} \
    -DCMAKE_ASM_COMPILER=${CC} \
    -DCMAKE_ASM_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_ASM_COMPILER_ID=Clang \
    -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
    -DCMAKE_C_COMPILER=${CC} \
    -DCMAKE_C_FLAGS="${ARCH_FLAGS} ${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL} ${CFLAGS}" \
    -DCMAKE_C_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_CXX_COMPILER=${CXX} \
    -DCMAKE_CXX_COMPILER_TARGET=${HOST_TRIPLE} \
    -DCMAKE_CXX_FLAGS="${ARCH_FLAGS} ${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL} ${CFLAGS}" \
    -DCMAKE_EXE_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_LINKER=${LD} \
    -DCMAKE_MODULE_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_NM=${NM} \
    -DCMAKE_OBJCOPY=${OBJCOPY} \
    -DCMAKE_OBJDUMP=${OBJDUMP} \
    -DCMAKE_PREFIX_PATH=${BINDIR}/lib/pkgconfig \
    -DCMAKE_RANLIB=${RANLIB} \
    -DCMAKE_RC_COMPILER=${RC} \
    -DCMAKE_READELF=${READELF} \
    -DCMAKE_STRINGS=${STRINGS} \
    -DCMAKE_STRIP=${STRIP} \
    -DCMAKE_SHARED_LINKER_FLAGS="${FLTO_LDFLAG} ${LDFLAGS} ${LIBS}" \
    -DCMAKE_SYSTEM_PROCESSOR=${BUILD_PROCESSOR} \
    "$@"
