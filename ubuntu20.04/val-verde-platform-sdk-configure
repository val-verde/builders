#!/bin/bash

set -e

BINDIR=${BINDIR:-${PACKAGE_ROOT}/bin}
BINTOOLS_PREFIX=${BINTOOLS_PREFIX:-llvm-}
BINTOOLS_PATH_PREFIX=${BINDIR}/${BINTOOLS_PREFIX}
LINKER_OPTIMIZATION_LEVEL=${LINKER_OPTIMIZATION_LEVEL:-2}
OPTIMIZATION_LEVEL=${OPTIMIZATION_LEVEL:-z}
SYSROOT=${SYSROOT:-${PACKAGE_ROOT}/${PACKAGE_BASE_NAME}-platform-sdk-${HOST_OS}${HOST_OS_API_LEVEL}-${HOST_PROCESSOR}/sysroot}

LDFLAGS="${ARCH_FLAGS} ${LDFLAGS} -O${LINKER_OPTIMIZATION_LEVEL}"

if [ -z "${DISABLE_STRIP}" ]; then
    LDFLAGS="${LDFLAGS} -s"
fi

if [ -n "${ENABLE_FLTO}" ]; then
    FLTO_OPTION=`echo ${ENABLE_FLTO} | tr '[:upper:]' '[:lower:]'`
    FLTO_CFLAG="-flto=${FLTO_OPTION}"
    LDFLAGS="${LDFLAGS} ${FLTO_CFLAG}"
fi

if [ -n "${LDFLAGS}" ]; then
    LDFLAGS_CMD="LDFLAGS=${LDFLAGS}"
fi

if [ -n "${LIBS}" ]; then
    LIBS_CMD="LIBS=${LIBS}"
fi

AR=${AR:-${BINTOOLS_PATH_PREFIX}ar}
CC=${CC:-${BINDIR}/${PACKAGE_BASE_NAME}-platform-sdk-clang}
CPP=${CPP:-"${CC} -E"}
CXX=${CXX:-${BINDIR}/${PACKAGE_BASE_NAME}-platform-sdk-clang++}
DLLTOOL=${DLLTOOL:-${BINTOOLS_PATH_PREFIX}dlltool}
LD=${LD:-${BINDIR}/ld.lld}
MANIFEST_TOOL=${MANIFEST_TOOL:-${BINTOOLS_PATH_PREFIX}mt}
NM=${NM:-${BINTOOLS_PATH_PREFIX}nm}
OBJCOPY=${OBJCOPY:-${BINTOOLS_PATH_PREFIX}objcopy}
OBJDUMP=${OBJDUMP:-${BINTOOLS_PATH_PREFIX}objdump}
RANLIB=${RANLIB:-${BINTOOLS_PATH_PREFIX}ranlib}
RC=${RC:-${BINTOOLS_PATH_PREFIX}rc}
READELF=${READELF:-${BINTOOLS_PATH_PREFIX}readelf}
SIZE=${SIZE:-${BINTOOLS_PATH_PREFIX}size}
STRINGS=${STRINGS:-${BINTOOLS_PATH_PREFIX}strings}
STRIP=${STRIP:-${BINTOOLS_PATH_PREFIX}strip}

"$@" AR=${AR} \
     AS=${CC} \
     CC=${CC} \
     CFLAGS="${ARCH_FLAGS} ${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL} ${CFLAGS}" \
     CPP="${CPP}" \
     CXX=${CXX} \
     CXXFLAGS="${ARCH_FLAGS} ${FLTO_CFLAG} -O${OPTIMIZATION_LEVEL} ${CXXFLAGS}" \
     DLLTOOL=${DLLTOOL} \
     LD=${LD} \
     LIBTOOLFLAGS="-avoid-version" \
     MANIFEST_TOOL=${MANIFEST_TOOL} \
     NM=${NM} \
     OBJCOPY=${OBJCOPY} \
     OBJDUMP=${OBJDUMP} \
     PKG_CONFIG_PATH=${SYSROOT}/usr/lib/pkgconfig \
     RANLIB=${RANLIB} \
     RC=${RC} \
     READELF=${READELF} \
     SIZE=${SIZE} \
     STRIP=${STRIP} \
     STRINGS=${STRINGS} \
    --build=${BUILD_TRIPLE} \
    --host=${HOST_TRIPLE} \
    "${CONFIGURE_FLAGS}" \
    "${LDFLAGS_CMD}" \
    "${LIBS_CMD}"
