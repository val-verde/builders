#!/bin/bash

if [ "${ENABLE_FLTO}" = "Full" ]; then
    FLTO_CFLAG="-Xcc -flto"
    FLTO_CXXFLAG="-Xcxx -flto"
    FLTO_LDFLAG="-Xlinker -s -Xlinker -O2"
fi

BINDIR=${PACKAGE_ROOT}/bin
OPTIMIZATION_LEVEL=${OPTIMIZATION_LEVEL:-z}
SYSROOT=${PACKAGE_ROOT}/${PACKAGE_BASE_NAME}-platform-sdk-${HOST_OS}${HOST_OS_API_LEVEL}-${HOST_PROCESSOR}/sysroot

${BINDIR}/${PACKAGE_BASE_NAME}-platform-sdk-swift-tool build \
    -Xcc -O${OPTIMIZATION_LEVEL} \
    -Xcxx -O${OPTIMIZATION_LEVEL} \
    -Xswiftc -whole-module-optimization \
    -Xswiftc -Osize \
    --build-path ${STAGE_ROOT} \
    --configuration release \
    --enable-test-discovery \
    ${FLTO_CFLAG} \
    ${FLTO_CXXFLAG} \
    ${FLTO_LDFLAG}