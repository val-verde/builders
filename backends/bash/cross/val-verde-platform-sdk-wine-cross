#!/bin/bash

set -e

# Source package build helper functions
source /usr/libexec/${VAL_VERDE_GH_TEAM}-platform-sdk-builder-utils

# Invoke one-shot template for stage/configure/install
if [ "${HOST_TRIPLE}" != "${BUILD_TRIPLE}" ]; then
    CROSS_CMD="--with-wine-tools=${STAGE_ROOT_BASE}/${SOURCE_PACKAGE_NAME}-${SOURCE_PACKAGE_VERSION}-${BUILD_OS}${BUILD_OS_API_LEVEL}-${BUILD_CPU}/build"
    WINEBUILD="`package-get-path winebuild EXECUTABLE BUILD`"
fi

ENABLE_OR_DISABLE_WIN64=enable

if [ "${HOST_PROCESSOR}" = "i686" ]; then
    ENABLE_OR_DISABLE_WIN64=disable
fi

WITH_OR_WITHOUT_UDEV=without

if [ "${HOST_OS}" = "musl" ] ||
   [ "${HOST_OS}" = "gnu" ]; then
    WITH_OR_WITHOUT_UDEV=with
fi

ENABLE_LD_AS_CCLD=TRUE \
FREETYPE_CFLAGS="-I${PACKAGE_PREFIX}/include/freetype2" \
FREETYPE_LIBS="-lfreetype" \
WINEBUILD=${WINEBUILD} \
package-stage-configure-install-archive \
    ac_cv_lib_soname_freetype=`package-get-filename freetype SHARED HOST` \
    --disable-static \
    --enable-shared \
    --with-unwind \
    --without-vkd3d \
    ${CROSS_CMD} \
    --${ENABLE_OR_DISABLE_WIN64}-win64 \
    --${WITH_OR_WITHOUT_UDEV}-udev
