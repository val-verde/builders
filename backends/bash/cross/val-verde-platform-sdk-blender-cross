#!/bin/bash

set -e

# Source package build helper functions
source /usr/libexec/${VAL_VERDE_GH_TEAM}-platform-sdk-builder-utils

# Invoke one-shot template for cmake/install
if [ "${HOST_PROCESSOR}" = "i686" ] ||
   [ "${HOST_PROCESSOR}" = "x86_64" ]; then
    HAS_SSE=TRUE
else
    HAS_SSE=FALSE
fi

if [ "${HOST_PROCESSOR}" = "armv7a" ] ||
   [ "${HOST_PROCESSOR}" = "i686" ]; then
    MAKESDNA_POINTER_SIZE=4
elif [ "${HOST_PROCESSOR}" = "aarch64" ] ||
     [ "${HOST_PROCESSOR}" = "x86_64" ]; then
    MAKESDNA_POINTER_SIZE=8
fi

if [ "${BUILD_TRIPLE}" != "${HOST_TRIPLE}" ]; then
    BLENDER_NATIVE_STAGE_ROOT=${STAGE_ROOT_BASE}/${SOURCE_PACKAGE_NAME}-${SOURCE_PACKAGE_VERSION}-${BUILD_OS}${BUILD_OS_API_LEVEL}-${BUILD_CPU}
    BLENDER_NATIVE_STAGE_ROOT_BIN=${BLENDER_NATIVE_STAGE_ROOT}/bin
    DATATOC_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename datatoc EXECUTABLE BUILD`
    DATATOC_ICON_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename datatoc_icon EXECUTABLE BUILD`
    MAKESDNA_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename makesdna EXECUTABLE BUILD`
    MAKESRNA_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename makesrna EXECUTABLE BUILD`
    MSGFMT_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename msgfmt EXECUTABLE BUILD`
    SMAA_AREATEX_EXECUTABLE=${BLENDER_NATIVE_STAGE_ROOT_BIN}/`package-get-filename smaa_areatex EXECUTABLE BUILD`
fi

SSE2_BUILD_EXITCODE=0
SSE2_BUILD_EXITCODE_OUTPUT=0

CMAKE_INSTALL_PREFIX=${PACKAGE_PREFIX}/blender \
MAKESDNA_POINTER_SIZE=${MAKESDNA_POINTER_SIZE} \
package-cmake-install-archive \
    -DBoost_INCLUDE_DIRS=${PACKAGE_PREFIX}/include \
    -DBoost_LIBRARY_DIRS=${PACKAGE_PREFIX}/lib \
    -DBoost_LIBRARIES="-lboost_filesystem -lboost_locale -lboost_thread" \
    -DBOOST_CUSTOM=TRUE \
    -DCXX_HAS_SSE=${HAS_SSE} \
    -DDATATOC_EXECUTABLE=${DATATOC_EXECUTABLE} \
    -DDATATOC_ICON_EXECUTABLE=${DATATOC_ICON_EXECUTABLE} \
    -DLIBPULSE_INCLUDE_DIR=${PACKAGE_PREFIX}/include \
    -DLIBPULSE_LIBRARY=`package-get-path pulse SHARED HOST` \
    -DMAKESDNA_EXECUTABLE=${MAKESDNA_EXECUTABLE} \
    -DMAKESRNA_EXECUTABLE=${MAKESRNA_EXECUTABLE} \
    -DMSGFMT_EXECUTABLE=${MSGFMT_EXECUTABLE} \
    -DSMAA_AREATEX_EXECUTABLE=${SMAA_AREATEX_EXECUTABLE} \
    -DSUPPORT_SSE_BUILD=${HAS_SSE} \
    -DSUPPORT_SSE2_BUILD_EXITCODE=${SSE2_BUILD_EXITCODE} \
    -DSUPPORT_SSE2_BUILD_EXITCODE__TRYRUN_OUTPUT=${SSE2_BUILD_EXITCODE_OUTPUT} \
    -DWITH_CYCLES=TRUE \
    -DWITH_LZMA=TRUE \
    -DWITH_LZO=TRUE \
    -DWITH_HARU=FALSE \
    -DWITH_POTRACE=FALSE \
    -DWITH_PYTHON_INSTALL=TRUE \
    -DWITH_PYTHON_INSTALL_NUMPY=TRUE \
    -DWITH_PYTHON_INSTALL_REQUESTS=FALSE \
    -DWITH_PYTHON_INSTALL_ZSTANDARD=TRUE \
    -DWITH_PYTHON_MODULE=FALSE \
    -DWITH_SDL=TRUE \
    -DWITH_SYSTEM_GLEW=TRUE \
    -DWITH_XR_OPENXR=FALSE