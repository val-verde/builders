#!/bin/bash

set -e

# builder configuration defaults
BASE_DIRECTORY=$(echo "${PACKAGE_ROOT}" | cut -d "/" -f2)
DEPENDS=${DEPENDS:=''}
GETCONF=${GETCONF:-/usr/bin/getconf}
NUM_PROCESSORS=${NUM_PROCESSORS:-"$(($(${GETCONF} _NPROCESSORS_ONLN) + 1))"}
TARGETS=${TARGETS:-install}
VERSION=${VERSION:='1.0.0'}
SOURCE_FILE=${SOURCE_FILE:-/usr/share/${VAL_VERDE_GH_TEAM}-sources.json}

# global path variables
PACKAGE_PLATFORM_SDKROOT=${PACKAGE_ROOT}/${PACKAGE_BASE_NAME}-platform-sdk
SOURCE_ROOT_BASE=${PACKAGE_PLATFORM_SDKROOT}/sources
TAR_ROOT_BASE=${PACKAGE_PLATFORM_SDKROOT}/tar-archives
BUILD_PACKAGE_USR_PREFIX=${BUILD_PACKAGE_USR_PREFIX:-usr}
PACKAGE_USR_PREFIX=${PACKAGE_USR_PREFIX:-usr}

# global package configuration variables
# 'build' configuration
export BUILD_TRIPLE=${BUILD_PROCESSOR}-${BUILD_KERNEL}-${BUILD_OS}
export BUILD_4_TRIPLE=${BUILD_PROCESSOR}-${BUILD_ENV:-unknown}-${BUILD_KERNEL}-${BUILD_OS}

BUILD_PACKAGE_PLATFORM_SYSROOT=${PACKAGE_PLATFORM_SDKROOT}/${BUILD_OS}${BUILD_OS_API_LEVEL}-${BUILD_CPU}/sysroot
export BUILD_PACKAGE_PREFIX=${BUILD_PACKAGE_PREFIX:-${BUILD_PACKAGE_PLATFORM_SYSROOT}/${BUILD_PACKAGE_USR_PREFIX}}
export BUILD_SYSROOT=${BUILD_SYSROOT:-${BUILD_PACKAGE_PLATFORM_SYSROOT}}

# 'build' tools
BINDIR=${BINDIR:-${BUILD_PACKAGE_PREFIX}/bin}
export APT=${APT:-${BINDIR}/apt}
export AUTOGEN=${AUTOGEN:-${BINDIR}/autogen}
export AUTORECONF=${AUTORECONF:-${BINDIR}/autoreconf}
export AUTOUPDATE=${AUTOUPDATE:-${BINDIR}/autoupdate}
export BASENAME=${BASENAME:-${BINDIR}/basename}
export BASH=${BASH:-${BINDIR}/bash}
export BISON=${BISON:-${BINDIR}/bison}
export CAT=${CAT:-${BINDIR}/cat}
export CHMOD=${CHMOD:-${BINDIR}/chmod}
export CMP=${CMP:-/usr/bin/cmp}
export CP=${CP:-${BINDIR}/cp}
export CURL=${CURL:-${BINDIR}/curl}
export CUT=${CUT:-${BINDIR}/cut}
export DATE=${DATE:-${BINDIR}/date}
export DF=${DF:-${BINDIR}/df}
export DIFF=${DIFF:-/usr/bin/diff}
export DNF=${DNF:-${BINDIR}/dnf}
export DPKG=${DPKG:-${BINDIR}/dpkg}
export ECHO=${ECHO:-${BINDIR}/echo}
export ENV=${ENV:-${BINDIR}/env}
export EXPR=${EXPR:-${BINDIR}/expr}
export FALSE=${FALSE:-${BINDIR}/false}
export FILE=${FILE:-${BINDIR}/file}
export FIND=${FIND:-${BINDIR}/find}
export FLOCK=${FLOCK:-/usr/bin/flock}
export GAWK=${GAWK:-${BINDIR}/gawk}
export GETTEXT=${GETTEXT:-${BINDIR}/gettext}
export GIT=${GIT:-${BINDIR}/git}
export GPERF=${GPERF:-${BINDIR}/gperf}
export GREP=${GREP:-${BINDIR}/grep}
export HEAD=${HEAD:-${BINDIR}/head}
export HELP2MAN=${HELP2MAN:-${BINDIR}/help2man}
export JAVA=${JAVA:-${BINDIR}/java}
export JAVAC=${JAVAC:-${BINDIR}/javac}
export LESS=${LESS:-${BINDIR}/less}
export LSB_RELEASE=${LSB_RELEASE:-/usr/bin/lsb_release}
export INSTALL=${INSTALL:-${BINDIR}/install}
export LN=${LN:-${BINDIR}/ln}
export LS=${LS:-${BINDIR}/ls}
export M4=${M4:-${BINDIR}/m4}
export MAKEINFO=${MAKEINFO:-${BINDIR}/makeinfo}
export MIG=${MKDIR:-${BINDIR}/mig}
export MKDIR=${MKDIR:-${BINDIR}/mkdir}
export MKTEMP=${MKTEMP:-${BINDIR}/mktemp}
export MV=${MV:-${BINDIR}/mv}
export NICE=${NICE:-${BINDIR}/nice}
export PATCH=${PATCH:-/usr/bin/patch}
export PERL=${PERL:-${BINDIR}/perl}
export PYTHON=${PYTHON:-${BINDIR}/python3}
export READLINK=${READLINK:-${BINDIR}/readlink}
export RM=${RM:-"${BINDIR}/rm -f"}
export RMDIR=${RMDIR:-${BINDIR}/rmdir}
export RPM=${RPM:-${BINDIR}/rpm}
export RSYNC=${RSYNC:-${BINDIR}/rsync}
export SED=${SED:-${BINDIR}/sed}
export SORT=${SORT:-${BINDIR}/sort}
export SSH=${SSH:-${BINDIR}/ssh}
export STAT=${STAT:-${BINDIR}/stat}
export TAIL=${TAIL:-${BINDIR}/tail}
export TAR=${TAR:-${BINDIR}/tar}
export TEE=${TEE:-${BINDIR}/tee}
export TOUCH=${TOUCH:-${BINDIR}/touch}
export TR=${TR:-${BINDIR}/tr}
export TRUE=${TRUE:-${BINDIR}/true}
export UNAME=${UNAME:-${BINDIR}/uname}
export UNIQ=${UNIQ:-${BINDIR}/uniq}
export WC=${WC:-${BINDIR}/wc}
export WGET=${WGET:-${BINDIR}/wget}
export WHICH=${WHICH:-${BINDIR}/which}
export XARGS=${XARGS:-${BINDIR}/xargs}
export XZ=${XZ:-${BINDIR}/xz}

function build-system-tool() {
    BUILD_BINDIR=${BUILD_BINDIR:-/usr/bin}
    ENV=${ENV:-${BUILD_BINDIR}/env}
    BUILD_ARGS=${@}

    ${ENV} -i ${BASH} -lc 'for i in `cat /etc/environment`; do export $i; done; '"${BUILD_ARGS}"''
}

function package-determine-os-distribution() {
    if [[ "$(${LSB_RELEASE} --description)" = *Ubuntu* ]]; then
        echo "ubuntu"
    elif [[ "$(${LSB_RELEASE} --description)" = *Fedora* ]]; then
        echo "fedora"
    fi
}

# Establish base architecture for package-builder
# Assumes that deb is the default choice for archive tool on debian
# and rpm, the defualt choice on fedora distributions.
if [ "$(package-determine-os-distribution)" = "ubuntu" ]; then
    PACKAGE_ARCH=all
elif [ "$(package-determine-os-distribution)" = "fedora" ]; then
    PACKAGE_ARCH=noarch
fi

# [G]UNZIP and [G]ZIP environment variables are used as options to the tools
# and should not be exported
GUNZIP=${GUNZIP:-${BINDIR}/gunzip}
GZIP=${GZIP:-${BINDIR}/gzip}
UNZIP=${UNZIP:-${BINDIR}/unzip}
ZIP=${ZIP:-${BINDIR}/zip}

# 'build' paths
export DPKG_ADMINDIR=/var/lib/dpkg
export LD_LIBRARY_PATH=${BUILD_PACKAGE_PREFIX}/lib
export NODE_PATH=${PACKAGE_ROOT}/${PACKAGE_BASE_NAME}-platform-sdk/web
export PATH=${BUILD_PACKAGE_PREFIX}/bin:${PATH}
export TEMPDIR=${TEMPDIR:-/tmp}
TEMP_ROOT_BASE=${TEMPDIR}/org.${VAL_VERDE_GH_TEAM}
ARCHIVE_ROOT_BASE=${TEMP_ROOT_BASE}/archiving

# 'host' configuration
export HOST_TRIPLE=${HOST_TRIPLE:-${HOST_PROCESSOR}-${HOST_KERNEL}-${HOST_OS}${HOST_OS_API_LEVEL}}
export HOST_4_TRIPLE=${HOST_4_TRIPLE:-${HOST_PROCESSOR}-${HOST_ENV:-unknown}-${HOST_KERNEL}-${HOST_OS}${HOST_OS_API_LEVEL}}
PACKAGE_PLATFORM_SYSROOT=${PACKAGE_PLATFORM_SDKROOT}/${HOST_OS}${HOST_OS_API_LEVEL}-${HOST_CPU}/sysroot
export PACKAGE_PREFIX=${PACKAGE_PREFIX:-${PACKAGE_PLATFORM_SYSROOT}/${PACKAGE_USR_PREFIX}}
export SYSROOT=${SYSROOT:-${PACKAGE_PLATFORM_SYSROOT}}

function package-apt-install() {
    package-apt-tool install -y "${@}"
}

function package-apt-remove() {
    package-apt-tool remove -y "${@}"
    package-apt-tool autoremove -y
    package-apt-tool autoclean -y
}

function package-apt-tool() {
    TOOL_LOG=${STAGE_ROOT}/builder-apt-${1} \
    tool-log ${APT} ${@}
}

function package-archive-remove() {
    if [ "$(package-determine-os-distribution)" = "ubuntu" ]; then
        package-apt-remove "${@}"
    elif [ "$(package-determine-os-distribution)" = "fedora" ]; then
	    package-dnf-remove "${@}"
    fi
}

function package-determine-compression-option() {
    if [ "$(package-determine-os-distribution)" = "ubuntu" ]; then
        ${ECHO} "-Zzstd --no-uniform-compression"
    fi
}

function package-dnf-remove() {
    for i in ${@}; do
        PACKAGE_NAME=`${ECHO} ${i} | ${CUT} -d\* -f1`
        package-dnf-tool remove -y `package-dnf-repoquery --installed --queryformat '%{name}' ${PACKAGE_NAME}`
    done
}

function package-dnf-repoquery() {
    DISABLE_TOOL_LOG=TRUE \
    package-dnf-tool repoquery "${@}"
}

function package-dnf-tool() {
    if [ -z "${DISABLE_DNF_RELEASE_VER}" ]; then
        RELEASE_VER=`package-get-lsb-release-version`
        RELEASE_VER_CMD="--releasever ${RELEASE_VER}"
    else
        unset \
            RELEASE_VER \
            RELEASE_VER_CMD
    fi

    PYTHON_TOOL=${DNF} \
    TOOL_LOG=${STAGE_ROOT}/builder-dnf-${1} \
    tool-log package-python-tool ${RELEASE_VER_CMD} \
                                 "${@}"
}

function package-deb-build() {
    COMPRESSION_OPTION=`package-determine-compression-option`
    TOOL_LOG=${STAGE_ROOT}/builder-dpkg \
    tool-log ${DPKG}-deb --build ${COMPRESSION_OPTION} "${@}"
}

function package-deb-install() {
    package-dpkg-tool install "${@}"
}

function package-deb-remove() {
    package-dpkg-tool remove --force-depends "${@}"
}

function package-dpkg-tool() {
    TOOL_LOG=${STAGE_ROOT}/builder-dpkg-${1} \
    tool-log ${DPKG} "--${@}"
}

# package-get-filename <name> <EXECUTABLE|SHARED|STATIC> <BUILD|HOST>
function package-get-filename() {
    NAME=${1}
    TYPE=${2}
    VARIANT=${3}

    if [ -z "${VARIANT}" ] ||
       [ "${VARIANT}" = "HOST" ]; then
        ENV_PREFIX=
    else
        ENV_PREFIX="${VARIANT}_"
    fi

    case ${TYPE} in
    EXECUTABLE)
        EXECUTABLE_SUFFIX_VAR=${ENV_PREFIX}EXECUTABLE_SUFFIX
        RESULT=${NAME}${!EXECUTABLE_SUFFIX_VAR}
        ;;
    SCRIPT)
        RESULT=${NAME}
        ;;
    SHARED)
        SHARED_LIBRARY_PREFIX_VAR=${ENV_PREFIX}SHARED_LIBRARY_PREFIX
        SHARED_LIBRARY_SUFFIX_VAR=${ENV_PREFIX}SHARED_LIBRARY_SUFFIX
        RESULT=${!SHARED_LIBRARY_PREFIX_VAR}${NAME}${!SHARED_LIBRARY_SUFFIX_VAR}
        ;;
    STATIC)
        STATIC_LIBRARY_PREFIX_VAR=${ENV_PREFIX}STATIC_LIBRARY_PREFIX
        STATIC_LIBRARY_SUFFIX_VAR=${ENV_PREFIX}STATIC_LIBRARY_SUFFIX
        RESULT=${!STATIC_LIBRARY_PREFIX_VAR}${NAME}${!STATIC_LIBRARY_SUFFIX_VAR}
        ;;
    *)
        echo "package-get-filename: Unknown type ${TYPE}."
        exit 1
    esac

    echo ${RESULT}
}

function package-get-lsb-release-version() {
    ${LSB_RELEASE} -rs
}

# package-get-path <name> <EXECUTABLE|SCRIPT|SHARED|STATIC> <BUILD|HOST>
function package-get-path() {
    NAME=${1}
    TYPE=${2}
    VARIANT=${3}

    if [ -z "${VARIANT}" ] ||
       [ "${VARIANT}" = "HOST" ]; then
        ENV_PREFIX=
    else
        ENV_PREFIX="${VARIANT}_"
    fi

    if [ "${TYPE}" = "EXECUTABLE" ] ||
       [ "${TYPE}" = "SCRIPT" ]; then
        SUBDIR=bin
    else
        SUBDIR=lib
    fi

    PACKAGE_PREFIX_VAR=${ENV_PREFIX}PACKAGE_PREFIX

    if [ "${TYPE}" = "EXECUTABLE" ] &&
       [ "${VARIANT}" = "BUILD" ]; then
        RESULT=${BINDIR:-${!PACKAGE_PREFIX_VAR}/${SUBDIR}}
    else
        RESULT=${!PACKAGE_PREFIX_VAR}/${SUBDIR}
    fi

    RESULT=${RESULT}/`package-get-filename ${NAME} ${TYPE} ${VARIANT}`

    if [ -f "${RESULT}" ]; then
        echo ${RESULT}
    fi
}

function package-get-qualified-package-name() {
    QUALIFIED_PACKAGE_NAME=${1}-${2}-${HOST_OS}${HOST_OS_API_LEVEL}-${HOST_CPU}
    PACKAGE_NAME=${PACKAGE_BASE_NAME}-${QUALIFIED_PACKAGE_NAME}
}

function package-get-qualified-source-package-name() {
    PACKAGE_NAME=${PACKAGE_BASE_NAME}-${1}-sources
}

function package-get-source-package-version() {
    QUERIED_SOURCE_PACKAGE_VERSIONS="\
    $(jq -r --arg src "$1" \
    '.[] | select(.sourcePackageName==$src) | .sourcePackageVersion' \
    ${SOURCE_FILE})"

    VERSION=(${QUERIED_SOURCE_PACKAGE_VERSIONS}) # extract first reported version
    ${ECHO} ${VERSION}.0.0
}

function package-git-add() {
    package-git-tool add "${@}"
}

function package-git-clone() {
    DEPTH=${DEPTH:-1}
    GIT_BRANCH=${1}
    TARGET_ROOT=${TARGET_ROOT:-${SOURCE_ROOT}}

    package-push-directory /sources
        if [ -d "${TARGET_ROOT}" ]; then
            ${RM} -rf ${TARGET_ROOT}
        fi

        if [ `${ECHO} ${RETAIN_SOURCE^^}` != 'TRUE' ]; then
            DEPTH_CMD="--depth=${DEPTH}"
        fi

        if [ -z "${DISABLE_RECURSIVE_CLOSE}" ]; then
            RECURSE_SUBMODULE_CMD="--recurse"
        fi

        package-git-tool clone ${GIT_URL} \
                               --branch ${GIT_BRANCH} \
                               --single-branch \
                               ${DEPTH_CMD} \
                               ${RECURSE_SUBMODULE_CMD} \
                               ${TARGET_ROOT}

    package-pop-directory
}

function package-git-commit() {
    package-git-tool commit "${@}"
}

function package-git-init() {
    package-git-tool init "${@}"
}

function package-git-submodule() {
    package-git-tool init "${@}"
}

function package-git-tool() {
    failed=FALSE
    TOOL_LOG=${STAGE_ROOT}/builder-git-${1} \
    tool-log ${GIT} "${@}" || failed=TRUE

    while [ "${failed}" = "TRUE" ]; do
        failed=false
        TOOL_LOG=${STAGE_ROOT}/builder-git-${1} \
        tool-log ${GIT} "${@}" || failed=TRUE
    done
}

function package-get-major-version() {
    MAJOR_VERSION=`${ECHO} "${1}" | ${CUT} -d "." -f1`
    ${ECHO} ${MAJOR_VERSION}
}

function package-get-source-package-data() {
    QUERIED_SOURCE_PACKAGE_VERSION=`package-get-source-package-version ${1}`
    PACKAGE_MAJOR_VERSION=`package-get-major-version ${QUERIED_SOURCE_PACKAGE_VERSION}`
    echo ${1}-${PACKAGE_MAJOR_VERSION}
}

function package-push-directory() {
    pushd ${@} > /dev/null
}

function package-pop-directory() {
    popd ${@} > /dev/null
}

function package-python-tool {
    PYTHON_TOOL=${PYTHON_TOOL:-${PYTHON}}

    _PYTHON_HOST_PLATFORM= \
    _PYTHON_SYSCONFIGDATA_NAME= \
    PYTHONHOME= \
    PYTHONPATH= \
    ${PYTHON_TOOL} ${@}
}

function package-rpm-build() {
    TOOL_LOG=${STAGE_ROOT}/builder-rpm-build \
    tool-log ${RPM}build "${@}"
}

function package-rpm-install() {
    TOOL_LOG=${STAGE_ROOT}/builder-rpm-install \
    tool-log ${RPM} -ivh "${@}"
}

function package-rpm-remove() {
    TOOL_LOG=${STAGE_ROOT}/builder-rpm-remove \
    tool-log ${RPM} -e "${@}"
}

function package-rsync() {
    TOOL_LOG=${STAGE_ROOT}/builder-rsync \
    tool-log ${RSYNC} ${@}
}

function package-tar() {
    TOOL_LOG=${STAGE_ROOT}/builder-untar \
    tool-log ${TAR} ${@}
}

function package-unzip() {
    TOOL_LOG=${STAGE_ROOT}/builder-unzip \
    tool-log ${UNZIP} ${@}
}

function package-wget() {
    TOOL_LOG=${STAGE_ROOT}/builder-wget \
    tool-log ${WGET} ${@}
}

function package-zip() {
    TOOL_LOG=${STAGE_ROOT}/builder-zip \
    tool-log ${ZIP} ${@}
}

function tool-check() {
    SEARCH_KEY=${SEARCH_PATH}/${SEARCH_INPUT}
    if [ -f "${SEARCH_KEY}.${SEARCH_EXTENSION}" ]; then
        FILE_EXISTS='TRUE'
        SEARCH_RESULTS=`compgen -G "${SEARCH_KEY}*"`
    else
        FILE_EXISTS='FALSE'
    fi
}

function tool-log() {
    if [ -z "${DISABLE_TOOL_LOG}" ]; then
        "${@}" > ${TOOL_LOG}.log \
               2> ${TOOL_LOG}-stderr.log
    else
        "${@}"
    fi
}
