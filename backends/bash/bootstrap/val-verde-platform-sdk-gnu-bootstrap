#!/bin/bash

set -e

# Source package build helper functions
export \
    BINDIR=/usr/bin \
    C_COMPILER=clang

source /usr/libexec/${VAL_VERDE_GH_TEAM}-platform-sdk-builder-api
source /usr/libexec/${VAL_VERDE_GH_TEAM}-platform-sdk-builder-utils

${MKDIR} -p ${BUILD_PACKAGE_PREFIX}
package-rsync -ax \
              /usr/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-* \
              ${BUILD_PACKAGE_PREFIX}/bin/
${CHMOD} +x ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-clang \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-clang++ \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-gcc-mingw32 \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-ml64 \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-mslink \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-rc \
            ${BUILD_PACKAGE_PREFIX}/bin/${VAL_VERDE_GH_TEAM}-platform-sdk-swiftc

# cuda bootstrap build
package-invoke-builder cuda-bootstrap

# kernel-headers bootstrap build
BUILD_SYSROOT=/ \
package-invoke-builder kernel-headers

# glibc-interface bootstrap build
package-invoke-builder glibc-interface

# libcxx bootstrap build
package-invoke-builder libcxx-bootstrap

# llvm bootstrap build
package-invoke-builder llvm-project-bootstrap

# remove host compiler and libraries as it is superceded by bootstrapped clang
package-apt-remove \
    clang \
    libc++-dev \
    libc++1 \
    libunwind-dev \
    lld \
    llvm

export \
    AR=${BUILD_PACKAGE_PREFIX}/bin/llvm-ar \
    CC=${BUILD_PACKAGE_PREFIX}/bin/clang \
    CPP=${BUILD_PACKAGE_PREFIX}/bin/clang-cpp \
    CXX=${BUILD_PACKAGE_PREFIX}/bin/clang++ \
    LD=${BUILD_PACKAGE_PREFIX}/bin/ld.lld \
    NM=${BUILD_PACKAGE_PREFIX}/bin/llvm-nm \
    RANLIB=${BUILD_PACKAGE_PREFIX}/bin/llvm-ranlib \
    READELF=${BUILD_PACKAGE_PREFIX}/bin/llvm-readelf \
    STRINGS=${BUILD_PACKAGE_PREFIX}/bin/llvm-strings \
    STRIP=${BUILD_PACKAGE_PREFIX}/bin/llvm-strip

# bazel bootstrap build
package-invoke-builder bazel-bootstrap

# go bootstrap build
package-invoke-builder go-bootstrap
export GO=${BUILD_PACKAGE_PREFIX}/bin/go

# openjdk bootstrap build
package-invoke-builder openjdk-bootstrap

# rust bootstrap build
package-invoke-builder rust-bootstrap

# zlib bootstrap build
package-invoke-builder zlib

# libffi bootstrap build
package-invoke-builder libffi

# glib bootstrap build
package-invoke-builder glib

# pkg-config bootstrap build
package-invoke-builder pkg-config

# help2man bootstrap build
package-invoke-builder help2man

# z3 build
package-invoke-builder z3

# re2c build
package-invoke-builder re2c

# alive2 build
package-invoke-builder alive2

# hiredis build
package-invoke-builder hiredis

# souper build
package-invoke-builder souper

# android ndk build
package-invoke-builder android-ndk
